$ApiDefinitionPath = "C:\Path\to\API\Definition"
$OutputFilePath = "C:\Path\to\Output\File.raml"

function Resolve-RamlIncludes($filePath, [System.Collections.Generic.HashSet[string]]$visitedFiles) {
    $content = Get-Content -Path $filePath -Raw

    $lines = $content -split '\r?\n'
    $outputLines = @()

    foreach ($line in $lines) {
        if ($line.StartsWith('!include')) {
            $includePath = $line.Substring(9).Trim()
            $fullIncludePath = Join-Path -Path (Split-Path -Path $filePath) -ChildPath $includePath
            if (-not $visitedFiles.Contains($fullIncludePath)) {
                $visitedFiles.Add($fullIncludePath)
                $includeContent = Resolve-RamlIncludes -filePath $fullIncludePath -visitedFiles $visitedFiles
                $outputLines += $includeContent
            }
        } else {
            $outputLines += $line
        }
    }

    return $outputLines -join "`r`n"
}

$visitedFiles = [System.Collections.Generic.HashSet[string]]::new()
$outputContent = Resolve-RamlIncludes -filePath (Join-Path -Path $ApiDefinitionPath -ChildPath "main.raml") -visitedFiles $visitedFiles
$outputContent | Out-File -FilePath $OutputFilePath -Encoding UTF8

Write-Host "API definition files aggregated successfully into $OutputFilePath."
